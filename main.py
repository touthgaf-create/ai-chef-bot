#!/usr/bin/env python3
"""
AI Chef Bot - Railway –≤–µ—Ä—Å–∏—è
"""
import asyncio
import logging
import os
import sys
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import CommandStart
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Railway
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    stream=sys.stdout
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Railway
BOT_TOKEN = os.getenv("BOT_TOKEN")
PROXY_API_KEY = os.getenv("PROXY_API_KEY", "")
ADMIN_IDS = [int(x) for x in os.getenv("ADMIN_IDS", "").split(",") if x]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    sys.exit(1)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

def get_main_menu():
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞"""
    builder = InlineKeyboardBuilder()
    
    builder.row(
        InlineKeyboardButton(text="üç≥ –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç", callback_data="new_recipe"),
        InlineKeyboardButton(text="üìö –ú–æ–∏ —Ä–µ—Ü–µ–ø—Ç—ã", callback_data="my_recipes")
    )
    
    builder.row(
        InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile"),
        InlineKeyboardButton(text="‚≠êÔ∏è –ü—Ä–µ–º–∏—É–º", callback_data="premium")
    )
    
    builder.row(
        InlineKeyboardButton(text="‚ùì –ü–æ–º–æ—â—å", callback_data="help"),
        InlineKeyboardButton(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")
    )
    
    return builder.as_markup()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    
    # –õ–æ–≥–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    logger.info(f"üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id} (@{message.from_user.username})")
    
    welcome_text = f"""
üéâ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI Chef Bot!</b>

–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}! üëã

–Ø - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç:

üî∏ <b>–°–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã</b> –∏–∑ –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üî∏ <b>–≠–∫–æ–Ω–æ–º–∏—Ç—å –¥–µ–Ω—å–≥–∏</b> - –¥–æ 30.000‚ÇΩ –≤ –≥–æ–¥!
üî∏ <b>–ò–∑–±–µ–≥–∞—Ç—å –≤—ã–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è</b> –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üî∏ <b>–ì–æ—Ç–æ–≤–∏—Ç—å –≤–∫—É—Å–Ω–æ</b> –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

<b>üéÅ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
2Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –∑–∞ 30 —Å–µ–∫—É–Ω–¥
3Ô∏è‚É£ –ì–æ—Ç–æ–≤—å—Ç–µ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º!

<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç–∫–æ–Ω–æ–º–∏–∏:</b>
‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ä–æ—Å—Å–∏–π—Å–∫–∞—è —Å–µ–º—å—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ 30.000‚ÇΩ –≤ –≥–æ–¥
‚Ä¢ –° –Ω–∞—à–∏–º –±–æ—Ç–æ–º –≤—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ —ç—Ç–æ –Ω–∞ 80%
‚Ä¢ –≠—Ç–æ –∑–Ω–∞—á–∏—Ç —ç–∫–æ–Ω–æ–º–∏—è ~24.000‚ÇΩ –≤ –≥–æ–¥!

<i>üí° –°–æ–≤–µ—Ç: –Ω–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–∑ 4-5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤</i>

–ß—Ç–æ –±—É–¥–µ–º –≥–æ—Ç–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è? üë®‚Äçüç≥
    """
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )

@router.callback_query(F.data == "new_recipe")
async def new_recipe(callback):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞"""
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–ø–∏—Å–æ–∫", callback_data="write_list"),
        InlineKeyboardButton(text="üé§ –ì–æ–ª–æ—Å–æ–º", callback_data="voice_input")
    )
    builder.row(
        InlineKeyboardButton(text="üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å", callback_data="photo_input"),
        InlineKeyboardButton(text="üßæ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫", callback_data="receipt_input")
    )
    builder.row(
        InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_menu")
    )
    
    await callback.message.edit_text(
        "üì¶ <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞:\n\n"
        "üî∏ <b>–ù–∞–ø–∏—Å–∞—Ç—å —Å–ø–∏—Å–æ–∫</b> - —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±\n"
        "üî∏ <b>–ì–æ–ª–æ—Å–æ–º</b> - —É–¥–æ–±–Ω–æ –∫–æ–≥–¥–∞ —Ä—É–∫–∏ –∑–∞–Ω—è—Ç—ã\n"
        "üî∏ <b>–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</b> - –ò–ò —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã\n"
        "üî∏ <b>–ß–µ–∫ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞</b> - —á—Ç–æ –∫—É–ø–∏–ª–∏, —Ç–æ –∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–º\n\n"
        "<i>üí° –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–º</i>",
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "write_list")
async def write_list(callback):
    """–ó–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
    await callback.message.edit_text(
        "‚úèÔ∏è <b>–ù–∞–ø–∏—à–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</b>\n\n"
        "–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å:\n\n"
        "<b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
        "‚Ä¢ <i>–ö—É—Ä–∏—Ü–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫, —Å–º–µ—Ç–∞–Ω–∞</i>\n"
        "‚Ä¢ <i>–§–∞—Ä—à –≥–æ–≤—è–∂–∏–π, –º–∞–∫–∞—Ä–æ–Ω—ã, –ø–æ–º–∏–¥–æ—Ä—ã, —Å—ã—Ä</i>\n"
        "‚Ä¢ <i>–†—ã–±–∞, —Ä–∏—Å, –±—Ä–æ–∫–∫–æ–ª–∏, –ª–∏–º–æ–Ω</i>\n\n"
        "üìù –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.\n\n"
        "<i>‚ö° –ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —É–∫–∞–∂–µ—Ç–µ, —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—Å—è —Ä–µ—Ü–µ–ø—Ç!</i>",
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "my_recipes")
async def my_recipes(callback):
    """–ú–æ–∏ —Ä–µ—Ü–µ–ø—Ç—ã"""
    await callback.message.edit_text(
        "üìö <b>–í–∞—à–∏ —Ä–µ—Ü–µ–ø—Ç—ã</b>\n\n"
        "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"‚Ä¢ –†–µ—Ü–µ–ø—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: <b>0</b>\n"
        f"‚Ä¢ –î–µ–Ω–µ–≥ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ: <b>~0‚ÇΩ</b>\n"
        f"‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <b>0</b>\n\n"
        "üéØ <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤</b>\n\n"
        "–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç - —ç—Ç–æ –∑–∞–π–º—ë—Ç –≤—Å–µ–≥–æ 30 —Å–µ–∫—É–Ω–¥! üöÄ\n\n"
        "<i>üí° –ö–∞–∂–¥—ã–π —Ä–µ—Ü–µ–ø—Ç —ç–∫–æ–Ω–æ–º–∏—Ç –≤ —Å—Ä–µ–¥–Ω–µ–º 200-400‚ÇΩ</i>",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "profile")
async def profile(callback):
    """–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = callback.from_user.id
    username = callback.from_user.username or "–Ω–µ —É–∫–∞–∑–∞–Ω"
    first_name = callback.from_user.first_name
    
    await callback.message.edit_text(
        f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
        f"<b>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n"
        f"‚Ä¢ –ò–º—è: <b>{first_name}</b>\n"
        f"‚Ä¢ Username: <b>@{username}</b>\n"
        f"‚Ä¢ ID: <code>{user_id}</code>\n"
        f"‚Ä¢ –°—Ç–∞—Ç—É—Å: <b>üéÅ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</b>\n\n"
        f"<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</b>\n"
        f"‚Ä¢ –†–µ—Ü–µ–ø—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: <b>0</b>\n"
        f"‚Ä¢ –î–µ–Ω–µ–≥ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ: <b>~0‚ÇΩ</b>\n"
        f"‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ: <b>0</b>\n"
        f"‚Ä¢ –î–Ω–µ–π —Å –Ω–∞–º–∏: <b>1</b>\n\n"
        f"<b>üéØ –í–∞—à —É—Ä–æ–≤–µ–Ω—å:</b> –ù–∞—á–∏–Ω–∞—é—â–∏–π –ø–æ–≤–∞—Ä üë∂\n\n"
        f"<i>üí° –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å!</i>",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "premium")
async def premium(callback):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–º–∏—É–º"""
    
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞ 299‚ÇΩ", callback_data="buy_premium"),
        InlineKeyboardButton(text="üéÅ –ü—Ä–æ–º–æ–∫–æ–¥", callback_data="promo")
    )
    builder.row(
        InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_menu")
    )
    
    await callback.message.edit_text(
        f"‚≠êÔ∏è <b>AI Chef Premium</b>\n\n"
        f"<b>üí∞ –¶–µ–Ω–∞: –≤—Å–µ–≥–æ 299‚ÇΩ –≤ –º–µ—Å—è—Ü!</b>\n\n"
        f"<b>üéÅ –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç–µ:</b>\n"
        f"‚úÖ <b>50 —Ä–µ—Ü–µ–ø—Ç–æ–≤ –≤ –¥–µ–Ω—å</b> (–≤–º–µ—Å—Ç–æ 2)\n"
        f"‚úÖ <b>GPT-4</b> –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤\n"
        f"‚úÖ <b>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ</b> –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ —á–µ–∫–æ–≤\n"
        f"‚úÖ <b>–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</b> –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n"
        f"‚úÖ <b>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é</b> –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
        f"‚úÖ <b>–°–ø–∏—Å–∫–∏ –ø–æ–∫—É–ø–æ–∫</b> —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π\n"
        f"‚úÖ <b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π</b> –∏ –ë–ñ–£\n"
        f"‚úÖ <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∏–µ—Ç—ã</b> –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è\n"
        f"‚úÖ <b>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</b>\n\n"
        f"<b>üí° –≠—Ç–æ –¥–µ—à–µ–≤–ª–µ —á–µ–º:</b>\n"
        f"‚Ä¢ 1 –ø–æ—Ö–æ–¥ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω\n"
        f"‚Ä¢ 3 —á–∞—à–∫–∏ –∫–æ—Ñ–µ –≤ –∫–∞—Ñ–µ\n"
        f"‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤—ã–±—Ä–æ—Å–∏—Ç–µ –∑–∞ 1 –¥–µ–Ω—å\n\n"
        f"<b>üéØ ROI: —ç–∫–æ–Ω–æ–º–∏—è 24.000‚ÇΩ –ø—Ä–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ 3.588‚ÇΩ –≤ –≥–æ–¥</b>\n\n"
        f"<i>üî• –ü–µ—Ä–≤—ã–µ 7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</i>",
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query(F.data == "help")
async def help_command(callback):
    """–ü–æ–º–æ—â—å"""
    await callback.message.edit_text(
        "‚ùì <b>–ü–æ–º–æ—â—å –ø–æ AI Chef Bot</b>\n\n"
        "<b>üî∏ –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç:</b>\n"
        "1. –ù–∞–∂–º–∏—Ç–µ 'üç≥ –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç'\n"
        "2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤–≤–æ–¥–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n"
        "3. –£–∫–∞–∂–∏—Ç–µ —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–º–∞\n"
        "4. –ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –∑–∞ 30 —Å–µ–∫\n\n"
        "<b>üî∏ –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤:</b>\n"
        "‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ 4-8 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n"
        "‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ø–µ—Ü–∏–∏ –∏ –ø—Ä–∏–ø—Ä–∞–≤—ã\n"
        "‚Ä¢ –£—Ç–æ—á–Ω—è–π—Ç–µ —Ç–∏–ø –±–ª—é–¥–∞ (–æ–±–µ–¥, —É–∂–∏–Ω, –∑–∞–≤—Ç—Ä–∞–∫)\n"
        "‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è\n\n"
        "<b>üî∏ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        "‚Ä¢ /start - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
        "‚Ä¢ /profile - –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "‚Ä¢ /premium - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ\n\n"
        "<b>üî∏ –ü—Ä–æ–±–ª–µ–º—ã –∏ –≤–æ–ø—Ä–æ—Å—ã:</b>\n"
        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–¥–¥–µ—Ä–∂–∫–∞'",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.message()
async def handle_products(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
    
    if len(message.text) < 5:
        await message.answer(
            "ü§î –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞.\n\n"
            "<i>–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—É—Ä–∏—Ü–∞, –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫</i>",
            parse_mode="HTML"
        )
        return
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    logger.info(f"üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–µ—Ü–µ–ø—Ç –∏–∑: {message.text[:50]}...")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    loading_msg = await message.answer("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —Å–æ–∑–¥–∞—é —Ä–µ—Ü–µ–ø—Ç...")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤)
    await asyncio.sleep(2)
    await loading_msg.edit_text("üë®‚Äçüç≥ –ü–æ–¥–±–∏—Ä–∞—é –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ...")
    await asyncio.sleep(2)
    await loading_msg.edit_text("üìù –°–æ—Å—Ç–∞–≤–ª—è—é –ø–æ—à–∞–≥–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç...")
    await asyncio.sleep(1)
    
    # –ü–∞—Ä—Å–∏–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    products = [p.strip().lower() for p in message.text.replace('\n', ',').split(',') if p.strip()]
    products_str = ', '.join(products[:5])  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ—Ü–µ–ø—Ç (–ø–æ–∫–∞ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è)
    recipe = f"""
üçΩ <b>–ê—Ä–æ–º–∞—Ç–Ω–æ–µ –±–ª—é–¥–æ –∏–∑ –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤</b>

<i>–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏ –≤–∫—É—Å–Ω–æ–µ –±–ª—é–¥–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º: {products_str}</i>

‚è± <b>–í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:</b> 35 –º–∏–Ω—É—Ç
üë• <b>–ü–æ—Ä—Ü–∏–π:</b> 4
üìä <b>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</b> –õ–µ–≥–∫–æ
üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> ~280‚ÇΩ

<b>üî• –ü–∏—Ç–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å (–Ω–∞ –ø–æ—Ä—Ü–∏—é):</b>
‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏: 340 –∫–∫–∞–ª
‚Ä¢ –ë–µ–ª–∫–∏: 26–≥ | –ñ–∏—Ä—ã: 14–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 32–≥

<b>üìù –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</b>
‚Ä¢ –í–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã: {products_str}
‚Ä¢ –°–æ–ª—å, —á–µ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ü - –ø–æ –≤–∫—É—Å—É
‚Ä¢ –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ - 2 —Å—Ç.–ª.
‚Ä¢ –í–æ–¥–∞ - 200 –º–ª

<b>üë®‚Äçüç≥ –ü–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</b>

<b>–®–∞–≥ 1:</b> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (5 –º–∏–Ω)
–ü–æ–º–æ–π—Ç–µ –∏ –Ω–∞—Ä–µ–∂—å—Ç–µ –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —É–¥–æ–±–Ω—ã–º–∏ –∫—É—Å–æ—á–∫–∞–º–∏. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Å–ø–µ—Ü–∏–∏.

<b>–®–∞–≥ 2:</b> –û–±–∂–∞—Ä–∫–∞ (10 –º–∏–Ω)
–†–∞–∑–æ–≥—Ä–µ–π—Ç–µ —Å–∫–æ–≤–æ—Ä–æ–¥—É —Å –º–∞—Å–ª–æ–º –Ω–∞ —Å—Ä–µ–¥–Ω–µ–º –æ–≥–Ω–µ. –û–±–∂–∞—Ä—å—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.

<b>–®–∞–≥ 3:</b> –¢—É—à–µ–Ω–∏–µ (20 –º–∏–Ω)
–î–æ–±–∞–≤—å—Ç–µ –≤–æ–¥—É, –ø—Ä–∏–ø—Ä–∞–≤—ã. –ù–∞–∫—Ä–æ–π—Ç–µ –∫—Ä—ã—à–∫–æ–π –∏ —Ç—É—à–∏—Ç–µ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–º –æ–≥–Ω–µ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.

<b>–®–∞–≥ 4:</b> –§–∏–Ω–∏—à
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞ —Å–æ–ª—å, –¥–æ–±–∞–≤—å—Ç–µ –∑–µ–ª–µ–Ω—å. –ü–æ–¥–∞–≤–∞–π—Ç–µ –≥–æ—Ä—è—á–∏–º!

üí° <b>–°–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞:</b> –ó–∞ 5 –º–∏–Ω—É—Ç –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –ª—é–±–∏–º—ã–µ —Å–ø–µ—Ü–∏–∏ - —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–∫—É—Å —è—Ä—á–µ!

<b>üè∑ –¢–µ–≥–∏:</b> #–¥–æ–º–∞—à–Ω–µ–µ #–±—ã—Å—Ç—Ä–æ #–∏–∑_–æ—Å—Ç–∞—Ç–∫–æ–≤ #—ç–∫–æ–Ω–æ–º–Ω–æ

<b>üí∞ –≠–∫–æ–Ω–æ–º–∏—è:</b> –í–º–µ—Å—Ç–æ –∑–∞–∫–∞–∑–∞ –µ–¥—ã (~800‚ÇΩ) –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ~280‚ÇΩ
<b>‚úÖ –í–∞—à–∞ –≤—ã–≥–æ–¥–∞: 520‚ÇΩ!</b>
"""
    
    # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ä–µ—Ü–µ–ø—Ç–æ–º
    builder = InlineKeyboardBuilder()
    builder.row(
        InlineKeyboardButton(text="üë®‚Äçüç≥ –ù–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤–∏—Ç—å", callback_data="start_cooking"),
        InlineKeyboardButton(text="‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", callback_data="add_favorite")
    )
    builder.row(
        InlineKeyboardButton(text="üîÑ –î—Ä—É–≥–æ–π —Ä–µ—Ü–µ–ø—Ç", callback_data="new_recipe"),
        InlineKeyboardButton(text="üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è", callback_data="share_recipe")
    )
    builder.row(
        InlineKeyboardButton(text="üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫", callback_data="shopping_list"),
        InlineKeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_menu")
    )
    
    await loading_msg.edit_text(
        recipe,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    
    # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    logger.info(f"‚úÖ –†–µ—Ü–µ–ø—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")

@router.callback_query(F.data == "back_menu")
async def back_to_menu(callback):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await callback.message.edit_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )
    await callback.answer()

@router.callback_query()
async def handle_other_callbacks(callback):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö callbacks"""
    callback_messages = {
        "voice_input": "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Premium –≤–µ—Ä—Å–∏–∏!",
        "photo_input": "üì∏ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Premium –≤–µ—Ä—Å–∏–∏!",
        "receipt_input": "üßæ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Premium –≤–µ—Ä—Å–∏–∏!",
        "start_cooking": "üë®‚Äçüç≥ –§—É–Ω–∫—Ü–∏—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!",
        "add_favorite": "‚≠ê –†–µ—Ü–µ–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!",
        "share_recipe": "üì§ –§—É–Ω–∫—Ü–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!",
        "shopping_list": "üõí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤ –ø–æ–∫—É–ø–æ–∫ –±—É–¥–µ—Ç –≤ Premium!",
        "buy_premium": "üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ü–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!",
        "promo": "üéÅ –í–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ–∑–∂–µ!",
        "support": "üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @your_support_username –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç"
    }
    
    message = callback_messages.get(callback.data, f"–§—É–Ω–∫—Ü–∏—è '{callback.data}' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üõ†")
    await callback.answer(message, show_alert=True)

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ AI Chef Bot –Ω–∞ Railway...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if not BOT_TOKEN:
        logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
        return
    
    logger.info(f"‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: {BOT_TOKEN[:10]}...")
    logger.info(f"üì° ProxyAPI: {'‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' if PROXY_API_KEY else '‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    logger.info(f"üë• –ê–¥–º–∏–Ω—ã: {ADMIN_IDS}")
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(router)
    
    try:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
        await bot.set_my_commands([
            ("start", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
            ("recipe", "üç≥ –ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç"),
            ("profile", "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"),
            ("premium", "‚≠ê –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞"),
            ("help", "‚ùì –ü–æ–º–æ—â—å")
        ])
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
        bot_info = await bot.get_me()
        logger.info(f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        logger.info(f"üì± Username: @{bot_info.username}")
        logger.info(f"üÜî Bot ID: {bot_info.id}")
        logger.info(f"üë§ –ò–º—è: {bot_info.first_name}")
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –æ –∑–∞–ø—É—Å–∫–µ
        for admin_id in ADMIN_IDS:
            try:
                await bot.send_message(
                    admin_id,
                    f"üöÄ <b>AI Chef Bot –∑–∞–ø—É—â–µ–Ω –Ω–∞ Railway!</b>\n\n"
                    f"ü§ñ @{bot_info.username}\n"
                    f"üïê –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {asyncio.get_event_loop().time()}\n"
                    f"üåê –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Railway\n"
                    f"‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ!",
                    parse_mode="HTML"
                )
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {admin_id}")
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
        
        logger.info("üéØ –ë–æ—Ç –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è!")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º polling
        await dp.start_polling(
            bot, 
            allowed_updates=dp.resolve_used_update_types(),
            drop_pending_updates=True
        )
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        raise

if __name__ == "__main__":
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ graceful shutdown
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)
